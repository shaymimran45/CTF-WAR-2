# üöÄ Render Deployment Guide

Complete guide to deploy your CTF Platform on Render.

## Prerequisites

- GitHub account (to connect repository)
- Render account (free tier works!)
- Supabase database already set up
- All database tables created via `supabase-schema.sql`

## Step 1: Prepare Your Repository

### 1.1 Push to GitHub

```powershell
# Initialize git (if not already)
git init

# Add all files
git add .

# Commit
git commit -m "Initial commit - CTF Platform ready for deployment"

# Add remote (replace with your GitHub repo URL)
git remote add origin https://github.com/YOUR_USERNAME/ctf-platform.git

# Push to GitHub
git push -u origin main
```

### 1.2 Verify Required Files

Make sure these files exist in your repo:
- ‚úÖ `render.yaml` - Render blueprint configuration
- ‚úÖ `build.sh` - Build script
- ‚úÖ `start.sh` - Start script
- ‚úÖ `package.json` - Dependencies
- ‚úÖ `supabase-schema.sql` - Database schema

## Step 2: Create Render Account

1. Go to https://render.com
2. Click "Get Started" or "Sign Up"
3. Sign up with GitHub (recommended)
4. Authorize Render to access your repositories

## Step 3: Deploy from GitHub

### Option A: Using Blueprint (Recommended)

1. **Go to Dashboard**
   - Click "New" ‚Üí "Blueprint"

2. **Connect Repository**
   - Select your `ctf-platform` repository
   - Render will detect `render.yaml` automatically

3. **Configure Service**
   - Service name: `ctf-platform` (or your choice)
   - Branch: `main`
   - Region: Choose closest to your users

4. **Set Environment Variables**
   
   Render will prompt for these variables from `render.yaml`:
   
   ```env
   SUPABASE_URL=https://vfhilobaycsxwbjojgjc.supabase.co
   SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmaGlsb2JheWNzeHdiam9qZ2pjIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzUzMTAwOCwiZXhwIjoyMDc5MTA3MDA4fQ.cjZaPWBs_t_ScE-A9p_Ew0YOSA29GLvgiMK6JcDJBvc
   SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmaGlsb2JheWNzeHdiam9qZ2pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1MzEwMDgsImV4cCI6MjA3OTEwNzAwOH0.9SFxiwMbCFoYJi8ITwOp7jEKacXkJFyRPvWtTRRMMvw
   ```
   
   **Important:** JWT_SECRET will be auto-generated by Render for security.

5. **Click "Apply"**
   - Render will start building and deploying
   - Build takes ~5-10 minutes

### Option B: Manual Setup

1. **Create New Web Service**
   - Go to Render Dashboard
   - Click "New" ‚Üí "Web Service"
   - Connect your GitHub repository

2. **Configure Build Settings**
   ```
   Name: ctf-platform-web
   Region: Oregon (or closest)
   Branch: main
   Runtime: Node
   Build Command: npm install && npm run build
   Start Command: npm start
   ```

3. **Add Environment Variables**
   Go to "Environment" tab and add all variables listed above.

4. **Deploy**
   - Click "Create Web Service"
   - Wait for deployment (~5-10 minutes)

## Step 4: Post-Deployment Setup

### 4.1 Verify Deployment

Once deployed, you'll get a URL like: `https://ctf-platform-web.onrender.com`

**Test these endpoints:**

```bash
# Health check
curl https://your-app.onrender.com/api/health

# Should return: {"success":true,"message":"ok"}
```

### 4.2 Create Admin User (If Needed)

If the start script didn't create the admin automatically:

1. Go to Render Dashboard ‚Üí Your Service ‚Üí "Shell"
2. Run:
   ```bash
   npx tsx api/src/scripts/createAdmin.ts
   ```

3. You should see:
   ```
   ‚úÖ Admin account created successfully!
   Email: ctfadmin2024@gmail.com
   Password: CTFSecureAdmin@2024!
   ```

### 4.3 Login to Your Platform

1. Open your Render URL: `https://your-app.onrender.com`
2. Login with admin credentials:
   - **Email:** ctfadmin2024@gmail.com
   - **Password:** CTFSecureAdmin@2024!

## Step 5: Configure Custom Domain (Optional)

### 5.1 Add Custom Domain in Render

1. Go to your service ‚Üí "Settings" ‚Üí "Custom Domain"
2. Click "Add Custom Domain"
3. Enter your domain: `ctf.yourdomain.com`

### 5.2 Update DNS Records

Add these DNS records at your domain provider:

**For subdomain (recommended):**
```
Type: CNAME
Name: ctf
Value: your-app.onrender.com
```

**For root domain:**
```
Type: A
Name: @
Value: [Render's IP - shown in dashboard]
```

### 5.3 Enable HTTPS

Render automatically provisions SSL certificates. Just:
1. Wait 5-10 minutes after adding domain
2. HTTPS will be enabled automatically

### 5.4 Update CORS Settings

Update environment variable:
```
CORS_ORIGIN=https://ctf.yourdomain.com
```

## Step 6: Production Checklist

Before going live, verify:

- ‚úÖ Database tables created in Supabase
- ‚úÖ Admin user created and can login
- ‚úÖ Health endpoint returns 200 OK
- ‚úÖ File uploads work (create test challenge with file)
- ‚úÖ Flag submissions work correctly
- ‚úÖ Leaderboard displays properly
- ‚úÖ HTTPS enabled (Render does this automatically)
- ‚úÖ Environment variables secured (especially JWT_SECRET and SUPABASE_SERVICE_ROLE_KEY)

## Monitoring & Maintenance

### View Logs

1. Go to Render Dashboard ‚Üí Your Service
2. Click "Logs" tab
3. View real-time application logs

### Check Metrics

1. Go to "Metrics" tab
2. Monitor:
   - CPU usage
   - Memory usage
   - Request count
   - Response times

### Auto-Deploy on Push

Render automatically deploys when you push to `main` branch:

```powershell
git add .
git commit -m "Update feature"
git push origin main
```

Render detects the push and redeploys (~2-5 minutes).

### Manual Deploy

If needed:
1. Go to service dashboard
2. Click "Manual Deploy" ‚Üí "Deploy latest commit"

## Troubleshooting

### Build Fails

**Issue:** Build command fails
**Solution:**
1. Check build logs in Render dashboard
2. Verify `package.json` has all dependencies
3. Run locally: `npm install && npm run build`

### App Crashes on Start

**Issue:** Start command fails
**Solution:**
1. Check logs for error messages
2. Verify environment variables are set correctly
3. Test locally: `npm start`

### Database Connection Issues

**Issue:** "relation does not exist" errors
**Solution:**
1. Verify Supabase credentials in environment variables
2. Make sure database schema was applied in Supabase
3. Re-run `supabase-schema.sql` in Supabase SQL Editor

### File Upload Issues

**Issue:** File uploads fail
**Solution:**
1. Render uses ephemeral filesystem - files are lost on restart
2. For production, consider using Supabase Storage or S3
3. Current setup uses `/tmp/uploads` (temporary)

### Admin User Not Created

**Issue:** Can't login as admin
**Solution:**
1. Go to Shell tab in Render
2. Run: `npx tsx api/src/scripts/createAdmin.ts`
3. Verify with: `npx tsx api/src/scripts/checkSetup.ts`

## Render Free Tier Limitations

‚ö†Ô∏è **Important limitations on free tier:**

- **Spins down after 15 minutes of inactivity**
  - First request after sleep takes ~30 seconds
  - Consider upgrading to paid tier for 24/7 uptime

- **750 hours/month free**
  - Enough for development/testing
  - For production, upgrade to Starter ($7/month)

- **Shared CPU & Memory**
  - Suitable for small CTF events (<100 concurrent users)
  - Upgrade for larger events

## Upgrading to Paid Tier

For better performance and reliability:

1. Go to your service ‚Üí "Settings"
2. Under "Instance Type", click "Change"
3. Select "Starter" ($7/month) or higher
4. Benefits:
   - No spin-down
   - Better performance
   - Priority support
   - More resources

## Environment Variables Reference

Complete list of environment variables:

```env
# Required
SUPABASE_URL=                    # Your Supabase project URL
SUPABASE_SERVICE_ROLE_KEY=       # Service role key (backend)
SUPABASE_ANON_KEY=               # Anon key (optional)
JWT_SECRET=                      # Auto-generated by Render

# Server
NODE_ENV=production
PORT=3001

# Admin (auto-created on first deploy)
ADMIN_EMAIL=ctfadmin2024@gmail.com
ADMIN_USERNAME=ctfadmin
ADMIN_PASSWORD=CTFSecureAdmin@2024!

# Features
FLAG_PREFIXES=CTF,flag,FLAG,ctf
UPLOAD_DIR=/tmp/uploads
MAX_FILE_SIZE=10485760

# Security
CORS_ORIGIN=*                    # Set to your domain in production
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
JWT_EXPIRES_IN=7d
```

## Scaling for Large Events

If expecting >100 concurrent users:

1. **Upgrade Render Plan**
   - Starter: ~200 users
   - Standard: ~500 users
   - Pro: 1000+ users

2. **Enable Horizontal Scaling**
   - Go to "Scaling" tab
   - Increase instance count

3. **Add Redis** (Optional)
   - Improves session management
   - Add Redis service in Render
   - Update REDIS_URL environment variable

4. **Optimize Database**
   - Supabase free tier: good for development
   - For production: upgrade Supabase plan
   - Monitor query performance

## Backup Strategy

### Database Backups

Supabase automatically backs up your database:
- Point-in-time recovery available
- Export backup: Supabase Dashboard ‚Üí Database ‚Üí Backups

### Code Backups

- Code is in GitHub (already backed up)
- Render keeps deployment history
- Can rollback to previous deployment anytime

## Security Best Practices

‚úÖ **Do:**
- Keep service_role_key secret
- Use strong JWT_SECRET (auto-generated)
- Enable HTTPS (automatic on Render)
- Set specific CORS_ORIGIN in production
- Rotate admin password regularly

‚ùå **Don't:**
- Commit secrets to GitHub
- Use default passwords in production
- Expose service_role_key to frontend
- Disable rate limiting

## Getting Help

- **Render Docs:** https://render.com/docs
- **Render Community:** https://community.render.com
- **Supabase Docs:** https://supabase.com/docs
- **GitHub Issues:** Create issue in your repository

## Next Steps

After successful deployment:

1. ‚úÖ Change admin password
2. ‚úÖ Create test challenges
3. ‚úÖ Invite team members
4. ‚úÖ Set up monitoring/alerts
5. ‚úÖ Plan for backups
6. ‚úÖ Consider custom domain
7. ‚úÖ Load test before event

---

## Quick Reference

**Your Credentials:**
- **Admin Email:** ctfadmin2024@gmail.com
- **Admin Password:** CTFSecureAdmin@2024!
- **Supabase URL:** https://vfhilobaycsxwbjojgjc.supabase.co

**Useful Commands:**
```bash
# Create admin
npx tsx api/src/scripts/createAdmin.ts

# Check setup
npx tsx api/src/scripts/checkSetup.ts

# Test database
npx tsx api/src/scripts/testDatabase.ts

# View logs
render logs -s ctf-platform-web
```

**Support:**
- Need help? Create an issue on GitHub
- Check Render status: https://status.render.com

---

üéâ **Congratulations!** Your CTF Platform is now deployed and ready for action!
